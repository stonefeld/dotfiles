#!/bin/sh

app_name="pacman"

cache_file="${XDG_DATA_HOME:-$HOME/.local/share}/updates"

[ ! -f "$cache_file" ] && (touch $cache_file && echo 0 > $cache_file)

notify() {
	if [ $# -eq 2 ]; then
		message="$2 new upgrades available ($1 from last time)"
	elif [ $# -eq 1 ]; then
		message="There are $1 packages to upgrade"
	else
		message="There are no packages to upgrade"
	fi
	notify-send -a $app_name -i cloud-download "Package upgrade" "$message"
	canberra-gtk-play -i dialog-warning
}

last_count=$(cat $cache_file)
[ "$last_count" -eq 0 ] && last_available=false || last_available=true

count=$(checkupdates 2>/dev/null | wc -l)

if [ "$count" -gt 0 ]; then
	if [ "$last_available" = true ]; then
		if [ $last_count -lt $count ]; then
			echo $count > $cache_file
			notify $last_count $(( $count - $last_count ))
		else
			echo $count > $cache_file
			notify $count
		fi
	else
		echo $count > $cache_file
		notify $count
	fi
else
	echo 0 > $cache_file
	notify
fi
