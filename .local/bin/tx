#!/bin/bash

# If no argument is passed, select one from the already existing ones.
if [ -z "$*" ]; then
	session=$(tmux list-sessions | fzf | cut -d : -f 1)
	if [ -z "$TMUX" ]; then
		tmux attach-session -t "$session" && exit
	else
		tmux switch-client -t "$session" && exit
	fi
fi

# Get the session name.
session="$1"
shift

# Check if the session already exists and attach it if true.
tmux list-sessions | egrep "\<$session\>" &>/dev/null
if [ "$?" -eq 0 ]; then
	if [ -z "$TMUX" ]; then
		tmux attach-session -t "$session" && exit
	else
		tmux switch-client -t "$session" && exit
	fi
fi

# Move to the working directory.
[ ! -d "$1" ] && echo "txwork: cannot access '$1': No such file or directory" && exit
cd "$1"
shift

# Create the session and rename the first window.
tmux new-session -d -s "$session"
tmux rename-window -t "$session":1 "$1"
shift

# Create a counter for the widnow ids.
counter=2

# Create a window for each following argument.
for i in $*; do
	tmux new-window -t "$session":$counter -n "$i"
	let counter+=1
done

# Destroy the counter.
unset counter

# Attach the created session.
if [ -z "$TMUX" ]; then
	tmux attach-session -t "$session":1 && exit
else
	tmux switch-client -t "$session":1 && exit
fi
