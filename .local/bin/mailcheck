#!/bin/bash

pkill -RTMIN+7 dwmblocks

notify() {
	notify-send -i email "New mail!" "$2 new mail(s) in \`$1\` account."
	canberra-gtk-play -i dialog-warning
}

syncandnotify() {
	acc="$(echo "$account" | sed "s/.*\///")"
	mbsync -c ${XDG_CONFIG_HOME:-$HOME/.config}/isync/mbsyncrc -a
	new=$(find \
		"$HOME/.local/share/mail/$acc/INBOX/new/"\
		"$HOME/.local/share/mail/$acc/Inbox/new/"\
		"$HOME/.local/share/mail/$acc/inbox/new/"\
		"$HOME/.local/share/mail/$acc/INBOX/cur/"\
		"$HOME/.local/share/mail/$acc/Inbox/cur/"\
		"$HOME/.local/share/mail/$acc/inbox/cur/"\
		-type f -newer "${XDG_DATA_HOME:-$HOME/.local/share}/mailchecklastrun" 2>/dev/null)
	newcount=$(echo "$new" | sed '/^\s*$/d' | wc -l)
	[ $newcount -gt 0 ] && notify "$acc" "$newcount"
	echo "$newcount" > "${XDG_DATA_HOME:-$HOME/.local/share}/unread"
}

accounts="$(awk '/^Account/ { print $2 }' "${XDG_CONFIG_HOME:-$HOME/.config}/isync/mbsyncrc")"

for account in $accounts; do
	syncandnotify &
done

wait

touch "${XDG_CONFIG_HOME:-$HOME/.config}/mutt/.mailchecklastrun"
pkill -RTMIN+7 dwmblocks
