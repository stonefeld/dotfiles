#!/bin/bash

pkill -RTMIN+7 dwmblocks

lastrun="${XDG_CACHE_HOME:-$HOME/.cache}/mailchecklastrun"
mbsyncconf="${XDG_CONFIG_HOME:-$HOME/.config}/isync/mbsyncrc"
count=0

notify() {
	notify-send -i email "New mail!" "$2 new mail(s) in \`$1\` account."
	canberra-gtk-play -i dialog-warning
}

syncandnotify() {
	acc="$(echo "$account" | sed "s/.*\///")"
	mbsync -c "$mbsyncconf" "$acc"
	new=$(find \
		"$HOME/.local/share/mail/$acc/INBOX/new/"\
		"$HOME/.local/share/mail/$acc/Inbox/new/"\
		"$HOME/.local/share/mail/$acc/inbox/new/"\
		"$HOME/.local/share/mail/$acc/INBOX/cur/"\
		"$HOME/.local/share/mail/$acc/Inbox/cur/"\
		"$HOME/.local/share/mail/$acc/inbox/cur/"\
		-type f -newer "$lastrun" 2>/dev/null)
	newcount=$(echo "$new" | sed '/^\s*$/d' | wc -l)
	[ $newcount -gt 0 ] && notify "$acc" "$newcount"
    let count+=$newcount
}

accounts="$(awk '/^Account/ { print $2 }' "$mbsyncconf")"
for account in $accounts; do
	syncandnotify &
done
echo "$count" > "${XDG_DATA_HOME:-$HOME/.local/share}/unread"

wait

touch "$lastrun"
pkill -RTMIN+7 dwmblocks
